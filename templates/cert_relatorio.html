<template>
    <style>

    </style>

    <fieldset>
        <legend>Revisões</legend>        
        <div class="inline">
            <label for="edtRev">Revisão</label>
            <input type="text" class="only-view" id="edtRev" onfocus="this.select();" inputmode="decimal" onkeyup="valFloat(this,0)" value="0">
        </div>
        <div class="inline">
            <label for="edtHist">Histórico</label>
            <input type="text" id="edtHist" onfocus="this.select();" maxlength="50" value="Emissão Inicial">
        </div>
        <div class="inline">
            <label for="edtElab">Elaboração</label>
            <input type="text" id="edtElab" onfocus="this.select();" maxlength="50">
        </div>
        <div class="inline">
            <label for="edtAprov">Aprovação</label>
            <input type="text" id="edtAprov" onfocus="this.select();" maxlength="50">
        </div>
        <div class="inline">
            <label for="edtData">Data</label>
            <input type="date" id="edtData" onfocus="this.select();">
        </div>
        <table id="tblRev"></table>
        <div class="line">
            <button id="btnRev">Salvar Revisão</button>
        </div>

    </fieldset>

    <fieldset>
        <legend>Setores</legend>
        <div class="inline">
            <label for="estSetor">Nome</label>
            <input type="text" id="edtSetor" onfocus="this.select();" maxlength="20">
            <button id="btnSetor" class="btn-round"><span class="mdi mdi-plus-thick"></span></button>
        </div>
        <select id="cmbSetor" size="5"></select>


    </fieldset>

    <fieldset>
        <legend>Relatorios</legend>
        <select id="cmbRelat" size="5"></select>
        <div class="line">
            <button id="btnRelat">Gerar Relatório</button>
        </div>
    </fieldset>




</template>
<script>

    const pageData = main_data.cert_relatorio.data
    const pageFunc = main_data.cert_relatorio.func
    const pageScreen = document.querySelector('#card-cert_relatorio')

    function pageStart(){
        pageFunc.fillSetor()
        pageFunc.getRev()
        pageFunc.fillAnswers()
        pageFunc.fillRelat()
        pageScreen.querySelector('#edtData').value = today.getFormatDate()
    }

    function fieldRev(json){
        pageScreen.querySelector('#edtRev').value = Number(json.revisao)
        pageScreen.querySelector('#edtHist').value = json.historico
        pageScreen.querySelector('#edtElab').value = json.elab
        pageScreen.querySelector('#edtAprov').value = json.aprov
        pageScreen.querySelector('#edtData').value = json.data_hora.substr(0,10)
    }

    pageFunc.fillRelat = ()=>{
        listFiles(`../files/relatorios/${pageData.task.id}/`).then((resolve)=>{
            const json = JSON.parse(resolve)
            const cmb = pageScreen.querySelector('#cmbRelat')
            cmb.innerHTML = ''
            for(let i=2; i<json.length; i++){
                const opt = document.createElement('option')
                opt.value = json[i]
                opt.innerHTML = json[i]
                opt.data =json[i]
                cmb.appendChild(opt)
            }
        })
    }

    pageFunc.setSetor = (set=0)=>{
        const params = new Object
            params.id_taskcli= pageData.task.id
            params.setor = set ? set : pageScreen.querySelector('#edtSetor').value.trim()
            params.del = set ? 1 : 0
        if(params.setor.length){
            const myPromisse = queryDB(params,'TASK-13');
            myPromisse.then((resolve)=>{
                const json = JSON.parse(resolve)
                pageFunc.fillSetor()
                pageScreen.querySelector('#edtSetor').value = ''
            })
        }
    }

    pageFunc.fillSetor = ()=>{
        const params = new Object
            params.id_taskcli= pageData.task.id
            const myPromisse = queryDB(params,'TASK-12');
            myPromisse.then((resolve)=>{
                pageData.setores = JSON.parse(resolve)
                const cmb = pageScreen.querySelector('#cmbSetor')
                cmb.innerHTML = ''   
                for(let i=0; i<pageData.setores.length;i++){
                    const opt = document.createElement('option')
                    opt.value = pageData.setores[i].setor
                    opt.innerHTML = pageData.setores[i].setor
                    opt.data = pageData.setores[i]
                    cmb.appendChild(opt)
                }
                if(pageData.setores.length){
                    cmb.selectedIndex = 0
                }
            })
    }

    pageFunc.fillAnswers = ()=>{
        const params = new Object
            params.id_task_cli = pageData.task.id
        const myPromisse = queryDB(params,'TASK-9');
        myPromisse.then((resolve)=>{
            pageData.perguntas = JSON.parse(resolve)
        })
    }

    pageFunc.setRev = (del=0)=>{
        const params = new Object
            params.id_taskcli= pageData.task.id
            params.revisao = pageScreen.querySelector('#edtRev').value
            params.historico = del ? '' : pageScreen.querySelector('#edtHist').value.trim()
            params.elaboracao = pageScreen.querySelector('#edtElab').value.trim()
            params.aprovacao = pageScreen.querySelector('#edtAprov').value.trim()
            params.data = pageScreen.querySelector('#edtData').value + ' 00:00:00'

        const myPromisse = queryDB(params,'TASK-11');
        return myPromisse.then((resolve)=>{
            const json = JSON.parse(resolve)
            pageFunc.fillRev(json)
        })
    }

    pageFunc.getRev = ()=>{
        const params = new Object
            params.id_tarefa = pageData.task.id
        const myPromisse = queryDB(params,'TASK-10');
        myPromisse.then((resolve)=>{
            pageFunc.fillRev(JSON.parse(resolve))
        })
    }

    pageFunc.fillRev = (json)=>{
        pageData.rev = json
        const tbl = pageScreen.querySelector('#tblRev')
        tbl.head('Revisão,Histórico,Data')
        for(let i=0; i<json.length; i++){         
            tbl.plot(json[i],'revisao,historico,data_hora','int,Upp,dat')
            fieldRev(json[i])
        }
    }

    pageScreen.querySelector('#btnSetor').addEventListener('click',()=>{
        pageFunc.setSetor()
    })

    pageScreen.querySelector('#cmbSetor').addEventListener('dblclick',()=>{
        const setor = pageScreen.querySelector('#cmbSetor').value
        if(confirm(`Deseja realmente deletar o setor ${setor}`)){
            pageFunc.setSetor(setor)
        }
    })

    pageScreen.querySelector('#btnRev').addEventListener('click',()=>{
        pageFunc.setRev()
    })

    pageScreen.querySelector('#btnRelat').addEventListener('click',()=>{
        if(pageData.rev.length){
            if(confirm(`Deseja gerar uma nova revisão ${pageData.rev[pageData.rev.length-1].revisao.padStart(2,0)} deste relatório?`)){
                print_relatorio(pageData)
            }
        }else{
            alert('Primeiro precisa criar uma revisão inicial!')
            pageScreen.querySelector('#edtRev').value =  0
            pageScreen.querySelector('#edtHist').value = 'Emissão Inicial'
            pageScreen.querySelector('#edtElab').focus()
        }
    })

    pageScreen.querySelector('#tblRev').addEventListener('dblclick',(e)=>{
        if(confirm('Deseja deletar esta revisão?')){
            const data = e.target.parentNode.data
            pageScreen.querySelector('#edtRev').value = data.revisao
            pageFunc.setRev(1)
        }
    })

    pageScreen.querySelector('#tblRev').addEventListener('click',(e)=>{
            const data = e.target.parentNode.data
            fieldRev(data)
    })

    pageScreen.querySelector('#cmbRelat').addEventListener('click',(e)=>{
        const filename =  pageScreen.querySelector('#cmbRelat').value
        if(pageScreen.querySelector('#cmbRelat').selectedIndex >=0){
            window.open(window.location.href+`../files/relatorios/${pageData.task.id}/`+filename, '_blank').focus();
        }
    })

    function print_relatorio(obj){

        loading(1)
        let img = 'assets/icons/icon.png'

        doc = new jsPDF({
            orientation: 'portrait',
            format: 'a4'
        }) 

        const rev = obj.rev[obj.rev.length-1]

        function newPage(Y=55){
            doc.addPage();
            head()   
            txt.y = Y 
        }

        function addLine(N=1, botton=0){
            txt.y += txt.lineHeigth * N
            if(txt.y >= doc.internal.pageSize.getHeight() - botton){
                botton ? newPage() : null
                return false
            }
            return true
        }


        function head(){

            plotImg(img,10,10,20,20)

            doc.rect(5,5,doc.internal.pageSize.getWidth()-10,30)
            doc.rect(35,5,130,30)
            doc.setFontSize(20);
            txt.y = 22
            doc.setFont(undefined, 'bold')
            center_text(obj.task.tarefa.toUpperCase()+' '+obj.task.titulo.toUpperCase(),[55,150])        
            doc.setFontSize(10);
            try{
                doc.text('Código: '+obj.task.cod,168,15)
                doc.text('Data: '+rev.data_hora.viewDate(),168,20)
                doc.text('Revisão: '+rev.revisao.padStart(2,0),168,25)
            }catch{
                doc.text('Código: ',168,15)
                doc.text('Data: ',168,20)
                doc.text('Revisão: ',168,25)    
            }
        }

        function setores(){
            doc.rect(5,40,doc.internal.pageSize.getWidth()-10,80)
            doc.line(60,40,60,120)
            doc.line(110,40,110,120)

            doc.setFont(undefined, 'bold')
            doc.setFontSize(12)
            doc.line(5,46,doc.internal.pageSize.getWidth()-5,46)
            doc.text('Elaboração',20,44.5)
            doc.text('Setores Aplicáveis',67,44.5)
            doc.text('Sumário',146,44.5)

            doc.line(5,70,60,70)
            doc.line(5,76,60,76)
            doc.text('Aprovação',20,74)

            doc.setFont(undefined, 'normal')

            try{
                box(rev.elab,10,55,50)
                box(rev.aprov,10,85,50)
            }catch{
                null
            }


            txt.y = 53
            for(let i=0; i<obj.setores.length; i++){
                doc.text('\u2022 '+obj.setores[i].setor,62,txt.y)
                addLine(1.5)
            }

            txt.y = 53
            let sub_item = 0
            for(let i=0; i<obj.perguntas.length; i++){
                
                if(!Number(obj.perguntas[i].sub_item)){
                    doc.text((i+1-sub_item)+' - '+obj.perguntas[i].titulo,115,txt.y)
                    addLine(1.5)
                }else{
                    sub_item++
                }
            }
        }

        function revisoes(){
            doc.setFont(undefined, 'bold')
            doc.setFontSize(12);

            doc.rect(5,130,doc.internal.pageSize.getWidth()-10,6)
            doc.line(30,130,30,136)
            doc.line(60,130,60,136)
            doc.text('Revisão',10,134.5)
            doc.text('Data',40,134.5)
            doc.text('Histórico',120,134.5)

            doc.setFont(undefined, 'normal')
            for(let i=0; i<obj.rev.length; i++){
                doc.text(obj.rev[i].revisao.padStart(2,0),15,(140.5+6*i))
                doc.text(obj.rev[i].data_hora.viewDate(),34,(140.5+6*i))
                doc.text(obj.rev[i].historico.padStart(2,0),62,(140.5+6*i))

                doc.line(5,(142+6*i),doc.internal.pageSize.getWidth()-5,(142+6*i))
                doc.line(5,(136+6*i),5,(142+6*i))
                doc.line(30,(136+6*i),30,(142+6*i))
                doc.line(60,(136+6*i),60,(142+6*i))
                doc.line(doc.internal.pageSize.getWidth()-5,(136+6*i),doc.internal.pageSize.getWidth()-5,(142+6*i))
            }
        }

        async function questoes(){
            newPage()
            let images = []
            await listFiles(`../files/anexos/imagem/${obj.task.id}/`).then((resolve)=>{
                images = JSON.parse(resolve)
            })
            let sub = 0
            for(let i=0; i<obj.perguntas.length; i++){
                doc.setFont(undefined, 'bold')
                doc.setFontSize(12)
                let title = `${(i+1-sub).toString().padStart(2,0)} - ${obj.perguntas[i].titulo}` 
                if(Number(obj.perguntas[i].sub_item) && i>0){
                    let n = 1
                    while(Number(obj.perguntas[i-n].sub_item) && json[i-n].sub_item != undefined ){
                        n++
                    }
                    title = `${(i-sub).toString().padStart(2,0)}.${n} - ${obj.perguntas[i].titulo}`
                    sub++
                }

                if(images.includes(`${obj.perguntas[i].id_pergunta}.jpg`)){
                    txt.y>65 ?  newPage() : null
                }

                function print_title(){
                    doc.text(title,15,txt.y)
                    addLine(1,10,head)

                    doc.setFont(undefined, 'normal')
                    doc.setFontSize(10)
                    box(obj.perguntas[i].resposta,15,txt.y,doc.internal.pageSize.getWidth()-30,1)
                    addLine(3,10,head)
                }

                if(images.includes(`${obj.perguntas[i].id_pergunta}.jpg`)){

                    txt.y>65 ?  newPage() : null
                    print_title()

                    const url = `../files/anexos/imagem/${obj.task.id}/${obj.perguntas[i].id_pergunta}.jpg?`+ new Date().getTime()
                    const img = await makeImg(url)

                    const w = Math.round(px2mm(img.width))
                    const ar = Math.round(px2mm(img.height))/w

                    const page_w = Math.round(doc.internal.pageSize.getHeight()-txt.y-10)
                    const page_h = Math.round(doc.internal.pageSize.getWidth()-20)

                    let img_w = Number(page_w.toString())

                    if(ar > 1){
                        if(img_w *ar > page_h){
                            img_w = Math.round(page_h/ar)
                        }else if(w > page_w){
                            img_w = page_w
                        }
                    }

                    txt.x = Math.round(doc.internal.pageSize.getWidth()/2) - Math.round(img_w/2)
                    plotImg(url,txt.x,txt.y,img_w)
                    addLine(Math.round(img_w * ar),10,head)

                }else{
                    print_title()
                }
            }
        }

        function save(){
            savePDF(doc,`../files/relatorios/${obj.task.id}/`,`${obj.task.cliente}-${obj.task.cod}-rev_${obj.rev[obj.rev.length-1].revisao}.pdf`).then(()=>{
                main_data.cert_relatorio.func.fillRelat()
            })
        }

        const back = backFunc({'filename':`../../files/logos/${obj.id_cliente}.jpg`},1)
        back.then((resp)=>{
            img = JSON.parse(resp) ? `../files/logos/${obj.id_cliente}.jpg` : 'assets/icons/icon.png'
            head()
            setores()
            revisoes()
            questoes().then(()=>{
                save()
            })
        })  

    }



    pageStart()

</script>